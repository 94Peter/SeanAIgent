# 規格文件：簽到管理

## 一、總覽 (更新)

本功能提供管理員一個專屬頁面，用於管理當前時間所屬訓練時段的學員簽到。管理員可以查看該時段的所有預約者，並勾選已簽到的學員，提交簽到狀態。**簽到完成後，系統將自動發送 LINE LIFF 訊息通知管理員簽到結果，並關閉簽到頁面。**

## 二、通用規格

### 存取權限
*   **僅限管理員 (Admin Only)**：只有具備管理員權限的使用者才能開啟此頁面。後端 API 需進行權限驗證。

### 頁面類型
*   **LINE LIFF 頁面**：本頁面為 LINE LIFF 頁面，只能在 LINE App 環境中開啟，且不需要內部導覽至其他功能。

### 介面與體驗建議 (UI/UX)
*   **載入狀態**：頁面載入或提交簽到時，應有明確的載入指示。
*   **錯誤處理**：提交失敗時，顯示 Toast 提示。
*   **管理員介面風格**：應與現有管理介面（如果存在）保持一致。

## 三、頁面名稱

簽到管理 (Check-in Management)

## 四、使用者流程 (User Flow) (更新)

1.  **管理員進入頁面**：管理員透過特定連結（例如 `/admin/checkin`）進入簽到管理頁面。
2.  **系統自動識別時段**：頁面載入後，系統會自動判斷當前時間所屬的訓練時段。
3.  **顯示預約者列表**：頁面會列出該時段所有已預約的學員。每個學員旁會顯示其當前的簽到狀態（已簽到/未簽到）。
4.  **管理員勾選簽到**：管理員可以針對每個學員，勾選其簽到狀態。
5.  **提交簽到狀態**：管理員點擊「提交簽到」按鈕。
6.  **後端更新狀態並回傳 LIFF 訊息內容**：後端接收請求，更新資料庫中對應預約的簽到狀態，並回傳 LIFF 訊息的內容。
7.  **前端發送 LIFF 訊息並關閉視窗**：前端接收到後端回傳的訊息內容後，透過 `liff.sendMessages()` 發送訊息，並自動關閉 LIFF 視窗 (`liff.closeWindow()`)。
8.  **回饋提示**：前端顯示成功或失敗的 Toast 提示 (如果 LIFF 訊息發送失敗)。

## 五、主要畫面與元件

| 元件/欄位 | 類型 | 說明 |
| :--- | :--- | :--- |
| **時段資訊** | Text | 顯示當前簽到頁面所屬的時段，例如「10月26日 (週日) 09:00 - 10:30 @ 中和運動中心」。 |
| **預約者列表** | List | 顯示該時段所有已預約的學員。 |
| **學員姓名** | Text | 顯示預約學員的姓名（孩子姓名）。 |
| **簽到勾選框** | Checkbox | 每個學員旁有一個勾選框，管理員可勾選表示已簽到。 |
| **提交簽到按鈕** | Button | 點擊後提交所有勾選的簽到狀態。 |

## 六、後端 API 規格 (Backend API Specification) (更新)

### 1. 取得簽到列表

*   **方法**: `GET`
*   **路徑**: `/admin/checkin`
*   **參數**: 無 (後端根據當前時間自動判斷時段)
*   **權限**: 僅限管理員
*   **成功回傳**:
    *   **Code**: `200 OK`
    *   **Body**: 渲染後的簽到頁面 HTML，包含當前時段資訊及預約者列表。
*   **失敗回傳**:
    *   **Code**: `401 Unauthorized` (未登入或非管理員)
    *   **Code**: `404 Not Found` (當前時間無有效時段)
    *   **Header**: `HX-Trigger-After-Settle` 包含錯誤 Toast 的 JSON payload (URL 編碼)。

### 2. 提交簽到狀態

*   **方法**: `POST`
*   **路徑**: `/admin/checkin/submit`
*   **參數**:
    *   `slotId` (string): 當前時段的 ID。
    *   `checkedInBookingIds` ([]string): 已勾選簽到的預約 ID 列表。
    *   `_csrf` (string): CSRF token。
*   **權限**: 僅限管理員
*   **成功回傳**:
    *   **Code**: `200 OK`
    *   **Body**: JSON 格式，包含要透過 LIFF 發送的訊息內容。
        ```json
        {
          "liffMessage": "簽到結果通知... (完整訊息內容)"
        }
        ```
*   **失敗回傳**:
    *   **Code**: `401 Unauthorized` (未登入或非管理員)
    *   **Code**: `400 Bad Request` (參數錯誤)
    *   **Code**: `500 Internal Server Error` (資料庫更新失敗或訊息建構失敗)
    *   **Header**: `HX-Trigger-After-Settle` 包含錯誤 Toast 的 JSON payload (URL 編碼)。

## 七、LINE LIFF 訊息發佈

### 1. 觸發時機

*   前端接收到後端回傳的訊息內容後。

### 2. 訊息接收者

*   執行簽到操作的管理員的 LINE 帳號 (由前端發送至 LIFF 視窗關閉前)。

### 3. 訊息內容與格式設計

訊息將以文字形式發送，包含以下關鍵資訊：

```
簽到結果通知

課程：[日期] [開始時間] - [結束時間] @ [地點]
總預約人數：[X] 人
已簽到人數：[Y] 人
未簽到人數：[Z] 人

已簽到學員：
- [孩子姓名 1]
- [孩子姓名 2]
... (最多顯示 N 位，若超過則顯示「等 N 位」)

未簽到學員：
- [孩子姓名 A]
- [孩子姓名 B]
... (最多顯示 N 位，若超過則顯示「等 N 位」)

[選填] 查看詳細簽到：[簽到頁面連結]
```

**備註：**
*   `[X]` 為該時段總預約人數。
*   `[Y]` 為本次提交後，該時段的總簽到人數。
*   `[Z]` 為該時段的總未簽到人數。
*   「已簽到學員」和「未簽到學員」列表，為避免訊息過長，建議限制顯示數量（例如各顯示前 5 位），並在超過時顯示「等 N 位」。
*   `[簽到頁面連結]` 為該時段的簽到管理頁面連結，方便管理員快速回顧。

## 八、資料模型變更 (Data Model Changes)

### 1. `Appointment` 模型 (`internal/db/model/appointment.go`)

*   **新增欄位**: `IsCheckedIn bool `bson:"is_checked_in"`
    *   預設值為 `false`。
