# 規格文件：訓練預約系統

## 一、總覽

本系統提供使用者透過 LINE LIFF 頁面，瀏覽可預約的訓練時段、為孩子進行預約，並分享預約狀況。

系統核心由兩個主要頁面構成：
1.  **預約時段頁面**：用於瀏覽所有可預約的時段，並為孩子建立新的預約。
2.  **我的預約頁面**：詳細規格請參考 `my_bookings.spec` 檔案。

## 二、通用規格

### 使用者驗證 (Authentication)
為了識別使用者並記錄其預約，所有頁面都需要在 LINE App 環境中開啟，並透過 LIFF 取得使用者身份。

1.  **頁面初始化**: 進入頁面後，首先初始化 LINE LIFF SDK。
2.  **環境與登入檢查**:
    *   系統會檢查 `liff.isInClient()`。
    *   **非 LINE 環境或 LIFF 初始化失敗**: 頁面主要功能將被禁用，並顯示「請在 LINE App 中開啟此頁面以進行預約」的提示。
3.  **取得使用者資料**: 登入成功後，後端可透過 LIFF 驗證機制取得使用者的 `userId` 及 `displayName`。

### 導覽機制 (Navigation)
*   在頁面頂部，提供一個分頁導覽列，包含「預約時段」和「我的預約」兩個連結。
*   系統會自動高亮使用者所在的當前頁面分頁，方便使用者在兩個主要頁面之間快速切換。

### 介面與體驗建議 (UI/UX)
*   **即時回饋**: 所有預約與取消操作都應透過 HTMX 非同步完成，提供無刷新的流暢體驗。
*   **載入狀態**: 在 LIFF 初始化、載入時段列表等過程中，應提供明確的視覺提示。
*   **錯誤處理**: 所有非同步操作的失敗（如名額不足、後端錯誤）都應透過頁面右上角的 Toast 元件給予使用者清晰的回饋。

--- 

## 三、預約時段頁面 (`/training/booking`)

### 3.1 功能

讓使用者瀏覽所有未來的訓練時段，並為一或多個孩子報名。

### 3.2 主要畫面與元件

| 元件/欄位 | 類型 | 說明 |
| :--- | :--- | :--- |
| 導覽分頁 | Navigation | 「預約時段」與「我的預約」的切換連結。 |
| 日期標頭 | Header | 例如「10月26日 (週日)」。 |
| 時段卡片 | Card | 顯示單一時段的資訊。 |
| **時間與地點** | Text | 例如 "09:00 - 10:30 @ 中和運動中心」。 |
| **預約狀態** | Text | 顯示名額狀態，例如「已預約 2/5 人」。 |
| **新增預約表單** | Form | 當時段未額滿時顯示，包含一個姓名輸入框和「新增預約」按鈕。 |
| **已額滿按鈕** | Button | 當時段名額已滿時顯示的禁用狀態按鈕。 |

### 3.3 操作流程 (User Flow)

1.  使用者進入頁面，瀏覽可預約的時段。
2.  在某個未額滿的時段卡片中，於「輸入孩子姓名」的輸入框中，輸入**一個或多個**孩子的名字，並用**逗號 (`,`)** 分隔。例如：「小明, 小紅」。
3.  點擊 `[ 新增預約 ]` 按鈕。
4.  後端進行容量檢查。若名額不足，前端會收到錯誤通知並顯示 Toast 提示「名額不足」。
5.  若預約成功，該時段卡片會透過 HTMX 進行局部刷新，更新「預約狀態」的人數，並在卡片中顯示您預約的孩子姓名。同時，會彈出一個成功的 Toast 提示。
6.  使用者可以跳轉至「我的預約」頁面查看預約詳情。

--- 

## 四、後端 API 規格 (Backend API Specification)

### 1. 取得可預約時段列表
*   **Endpoint**: (由渲染 `BookTrainingPage` 的 Go handler `getBookingForm` 處理)
*   **描述**: 取得所有未來可預約的時段，並渲染整個預約頁面。

### 2. 取得個人預約列表
*   **Endpoint**: (由渲染 `MyBookingsPage` 的 Go handler `getMyBookingsPage` 處理)
*   **描述**: 取得當前使用者所有未來的預約記錄，並渲染「我的預約」頁面。

### 3. 建立預約
*   **方法**: `POST`
*   **路徑**: `/booking/create`
*   **參數**:
    *   `slotId` (string): 欲預約的時段 ID。
    *   `childName` (string): 一或多個孩子姓名，用逗號分隔。
*   **成功回傳**:
    *   **Code**: `200 OK`
    *   **Body**: 回傳更新後的「您的預約列表」HTML 片段，以及透過 OOB Swap 更新的「預約人數」HTML 片段。
    *   **Header**: `HX-Trigger-After-Settle` 包含成功 Toast 的 JSON payload (URL 編碼)。
*   **失敗回傳**:
    *   **Code**: `409 Conflict` (名額不足)。
    *   **Header**: `HX-Trigger-After-Settle` 包含錯誤 Toast 的 JSON payload (URL 編碼)。

### 4. 取得分享訊息
*   **方法**: `GET`
*   **路徑**: `/booking/summary/line-liff` (路徑已存在)
*   **描述**: 後端組合一份包含所有預約者（優先顯示孩子姓名）的完整文字訊息。

### 5. 取得 Toast 元件
*   **方法**: `GET`
*   **路徑**: `/components/toast`
*   **參數**: `title`, `description`, `variant`, `duration`
*   **成功回傳**: 回傳單一 Toast 元件的 HTML 片段。
