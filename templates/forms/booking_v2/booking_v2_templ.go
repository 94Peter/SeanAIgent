// Code generated by templ - DO NOT EDIT.

// templ: version: v0.3.943
package booking_v2

//lint:file-ignore SA4006 This context is only used if a nested component is present.

import "github.com/a-h/templ"
import templruntime "github.com/a-h/templ/runtime"

import (
	"encoding/json"
	"fmt"
	"time"
)

// --- View Models ---

// BookingV2Model contains all data required for the Booking V2 Page.
type BookingV2Model struct {
	LiffID      string
	Stats       *StatsSummary
	Weeks       []*WeekData
	CurrentUser *UserContext
	MyBookings  []*MyBookingItem
}

type UserContext struct {
	DisplayName      string
	UserID           string
	FrequentChildren []string
}

// MyBookingItem represents a booking entry in the "My Bookings" list.
type MyBookingItem struct {
	ID          string      `json:"id"`
	DateDisplay string      `json:"date_display"` // e.g. "02/14 (六) 14:30"
	Title       string      `json:"title"`        // e.g. "師大班 @ 師大附中"
	Attendees   []*Attendee `json:"attendees"`
}

// StatsSummary represents the 90-day statistics.
type StatsSummary struct {
	TotalSessions int          `json:"total_sessions"`
	TotalLeave    int          `json:"total_leave"`
	Children      []*ChildStat `json:"children"`
}

// ChildStat represents statistics for a single child.
type ChildStat struct {
	Name      string  `json:"name"`
	Completed int     `json:"completed"`
	Leave     int     `json:"leave"`
	Absent    int     `json:"absent"`
	AvgWeek   float64 `json:"avg_week"`
}

// WeekData represents a week in the calendar.
type WeekData struct {
	ID        string     `json:"id"` // e.g. "2026-W07"
	Days      []*DayData `json:"days"`
	IsCurrent bool       `json:"is_current"`
}

// DayData represents a day in the calendar.
type DayData struct {
	DateDisplay string      `json:"date_display"` // e.g. "13"
	DayOfWeek   string      `json:"day_of_week"`  // e.g. "Fri"
	FullDate    string      `json:"full_date"`    // e.g. "2026-02-13"
	IsToday     bool        `json:"is_today"`
	Slots       []*SlotData `json:"slots"`
}

// SlotData represents a time slot.
type SlotData struct {
	ID          string      `json:"id"`
	TimeDisplay string      `json:"time_display"` // e.g. "16:30"
	CourseName  string      `json:"course_name"`  // e.g. "足球"
	Location    string      `json:"location"`
	Capacity    int         `json:"capacity"`
	BookedCount int         `json:"booked_count"`
	Attendees   []*Attendee `json:"attendees"`
	IsFull      bool        `json:"is_full"`
	IsEmpty     bool        `json:"is_empty"` // If true, this is an empty slot (no course)
}

// Attendee represents a child in a slot.
type Attendee struct {
	Name        string    `json:"name"`
	Status      string    `json:"status"` // "Booked", "Leave", "CheckedIn", "Absent"
	BookingTime time.Time `json:"booking_time"`
	BookingID   string    `json:"booking_id"`
}

// --- Colors ---
// Using arbitrary values to match the spec exactly where standard Tailwind might differ.
const (
	BgBase       = "bg-[#000000]"
	BgSurface    = "bg-[#1C1C1E]"
	TextWhite    = "text-white"
	TextGray     = "text-[#8E8E93]"
	ColorPrimary = "text-[#FFD700]" // Gold
	ColorBlue    = "bg-[#60A5FA]"   // Blue-400
	ColorRed     = "text-[#F87171]" // Red-400
	ColorRedBg   = "bg-[#F87171]"   // Red-400
	ColorGreen   = "text-[#34D399]" // Emerald-400
	ColorGreenBg = "bg-[#34D399]"   // Emerald-400
	ColorZinc    = "bg-[#27272A]"   // Zinc-800 (Available)
)

// --- Components ---

// Page is the main entry point.
func Page(model *BookingV2Model) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var1 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var1 == nil {
			templ_7745c5c3_Var1 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		var templ_7745c5c3_Var2 = []any{"w-full h-[100dvh] flex flex-col font-sans overflow-hidden " + BgBase + " " + TextWhite}
		templ_7745c5c3_Err = templ.RenderCSSItems(ctx, templ_7745c5c3_Buffer, templ_7745c5c3_Var2...)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 1, "<div class=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var3 string
		templ_7745c5c3_Var3, templ_7745c5c3_Err = templ.JoinStringErrs(templ.CSSClasses(templ_7745c5c3_Var2).String())
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 1, Col: 0}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var3))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 2, "\"><!-- 1. Sticky Header -->")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = StickyHeader(model.Stats).Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 3, "<!-- 2. Main Calendar Area (Vertical Scroll) --><div id=\"calendar-container\" class=\"flex-grow overflow-y-auto snap-y snap-mandatory scroll-smooth pb-24 relative\"><!-- Sentinel Top --><div id=\"sentinel-top\" class=\"h-1 w-full shrink-0\"></div><!-- Initial Weeks -->")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		for _, week := range model.Weeks {
			templ_7745c5c3_Err = WeekRow(week).Render(ctx, templ_7745c5c3_Buffer)
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 4, "<!-- Sentinel Bottom --><div id=\"sentinel-bottom\" class=\"h-1 w-full shrink-0\"></div></div><!-- 3. Fixed FABs -->")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = FixedFABs().Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 5, "<!-- 4. Modals / Popups (Initially Hidden) -->")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = BookingPopup(model.CurrentUser).Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = MyBookingsModal(model.MyBookings).Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 6, "<!-- Initialization Script -->")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = Script(model.LiffID).Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 7, "</div>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// StickyHeader renders the top 90-day stats.
func StickyHeader(stats *StatsSummary) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var4 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var4 == nil {
			templ_7745c5c3_Var4 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 8, "<div class=\"sticky top-0 z-40 w-full bg-[#121212] border-b border-[#27272A] shadow-md transition-all duration-300\" x-data=\"{ expanded: false }\"><div class=\"px-4 py-3\"><div class=\"flex items-center justify-between\"><!-- Title & Primary Stat --><div><h2 id=\"current-month-title\" class=\"text-xl font-bold text-[#FFD700] leading-none mb-1\"><!-- Dynamic Date will be injected here via JS -->載入中...</h2><div class=\"flex items-baseline gap-2 text-xs text-[#8E8E93]\"><span id=\"stats-label\" class=\"font-medium\">90天統計:</span> <span id=\"total-sessions\" class=\"text-white font-bold text-sm\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var5 string
		templ_7745c5c3_Var5, templ_7745c5c3_Err = templ.JoinStringErrs(fmt.Sprintf("%d", stats.TotalSessions))
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 150, Col: 109}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var5))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 9, " 堂</span> <span>(請假 <span id=\"total-leave\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var6 string
		templ_7745c5c3_Var6, templ_7745c5c3_Err = templ.JoinStringErrs(fmt.Sprintf("%d", stats.TotalLeave))
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 151, Col: 80}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var6))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 10, "</span>)</span></div></div><!-- Expand Toggle --><button @click=\"expanded = !expanded\" class=\"p-2 text-[#8E8E93] hover:text-white transition-colors focus:outline-none\"><!-- Chevron Icon --><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"transform transition-transform duration-300\" :class=\"expanded ? 'rotate-180' : ''\"><polyline points=\"6 9 12 15 18 9\"></polyline></svg></button></div><!-- Expandable Table Area --><div x-show=\"expanded\" x-collapse class=\"mt-2 overflow-hidden\" style=\"display: none;\"><table class=\"w-full text-sm text-right\"><thead><tr class=\"text-[#8E8E93] border-b border-[#27272A]\"><th class=\"pb-2 text-left font-medium\">姓名</th><th class=\"pb-2 font-medium\">上課</th><th class=\"pb-2 font-medium\">請假</th><th class=\"pb-2 font-medium\">缺席</th><th class=\"pb-2 font-medium\">週均</th></tr></thead> <tbody id=\"stats-children-body\" class=\"text-white\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		for _, child := range stats.Children {
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 11, "<tr class=\"border-b border-[#27272A]/50 last:border-0\"><td class=\"py-2 text-left\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var7 string
			templ_7745c5c3_Var7, templ_7745c5c3_Err = templ.JoinStringErrs(child.Name)
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 188, Col: 47}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var7))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 12, "</td>")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var8 = []any{"py-2 " + ColorGreen}
			templ_7745c5c3_Err = templ.RenderCSSItems(ctx, templ_7745c5c3_Buffer, templ_7745c5c3_Var8...)
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 13, "<td class=\"")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var9 string
			templ_7745c5c3_Var9, templ_7745c5c3_Err = templ.JoinStringErrs(templ.CSSClasses(templ_7745c5c3_Var8).String())
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 1, Col: 0}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var9))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 14, "\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var10 string
			templ_7745c5c3_Var10, templ_7745c5c3_Err = templ.JoinStringErrs(fmt.Sprintf("%d", child.Completed))
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 189, Col: 79}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var10))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 15, "</td><td class=\"py-2 text-[#8E8E93]\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var11 string
			templ_7745c5c3_Var11, templ_7745c5c3_Err = templ.JoinStringErrs(fmt.Sprintf("%d", child.Leave))
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 190, Col: 72}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var11))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 16, "</td>")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var12 = []any{"py-2 " + cond(child.Absent > 0, ColorRed, "text-[#8E8E93]")}
			templ_7745c5c3_Err = templ.RenderCSSItems(ctx, templ_7745c5c3_Buffer, templ_7745c5c3_Var12...)
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 17, "<td class=\"")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var13 string
			templ_7745c5c3_Var13, templ_7745c5c3_Err = templ.JoinStringErrs(templ.CSSClasses(templ_7745c5c3_Var12).String())
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 1, Col: 0}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var13))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 18, "\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var14 string
			templ_7745c5c3_Var14, templ_7745c5c3_Err = templ.JoinStringErrs(fmt.Sprintf("%d", child.Absent))
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 191, Col: 116}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var14))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 19, "</td><td class=\"py-2 text-[#8E8E93]\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var15 string
			templ_7745c5c3_Var15, templ_7745c5c3_Err = templ.JoinStringErrs(fmt.Sprintf("%.1f", child.AvgWeek))
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 192, Col: 76}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var15))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 20, "</td></tr>")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 21, "</tbody></table></div></div></div>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// WeekRow renders a single week (7 days).
func WeekRow(week *WeekData) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var16 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var16 == nil {
			templ_7745c5c3_Var16 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 22, "<div class=\"snap-start pt-4 pb-2 border-b border-[#27272A] min-h-[50vh]\" data-week-id=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var17 string
		templ_7745c5c3_Var17, templ_7745c5c3_Err = templ.JoinStringErrs(week.ID)
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 204, Col: 96}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var17))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 23, "\"><!-- Days Grid --><div class=\"grid grid-cols-7 gap-1 px-1\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		for _, day := range week.Days {
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 24, "<div class=\"flex flex-col items-center gap-2 min-h-[120px]\" data-date=\"")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var18 string
			templ_7745c5c3_Var18, templ_7745c5c3_Err = templ.JoinStringErrs(day.FullDate)
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 208, Col: 88}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var18))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 25, "\"><!-- Date Circle -->")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var19 = []any{"flex flex-col items-center justify-center w-10 h-10 rounded-full text-sm font-medium " + cond(day.IsToday, "bg-white text-black", "text-[#8E8E93]")}
			templ_7745c5c3_Err = templ.RenderCSSItems(ctx, templ_7745c5c3_Buffer, templ_7745c5c3_Var19...)
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 26, "<div class=\"")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var20 string
			templ_7745c5c3_Var20, templ_7745c5c3_Err = templ.JoinStringErrs(templ.CSSClasses(templ_7745c5c3_Var19).String())
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 1, Col: 0}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var20))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 27, "\"><span class=\"text-[10px] uppercase leading-none\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var21 string
			templ_7745c5c3_Var21, templ_7745c5c3_Err = templ.JoinStringErrs(day.DayOfWeek)
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 211, Col: 70}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var21))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 28, "</span> <span class=\"text-lg leading-none font-bold\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var22 string
			templ_7745c5c3_Var22, templ_7745c5c3_Err = templ.JoinStringErrs(day.DateDisplay)
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 212, Col: 68}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var22))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 29, "</span></div><!-- Slots Stack --><div class=\"w-full flex flex-col gap-2 px-0.5\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			for _, slot := range day.Slots {
				if slot.IsEmpty {
					templ_7745c5c3_Err = EmptyCapsule(slot).Render(ctx, templ_7745c5c3_Buffer)
					if templ_7745c5c3_Err != nil {
						return templ_7745c5c3_Err
					}
				} else {
					templ_7745c5c3_Err = CourseCapsule(slot).Render(ctx, templ_7745c5c3_Buffer)
					if templ_7745c5c3_Err != nil {
						return templ_7745c5c3_Err
					}
				}
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 30, "</div></div>")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 31, "</div></div>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// CourseCapsule renders a booked/available slot.
func CourseCapsule(slot *SlotData) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var23 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var23 == nil {
			templ_7745c5c3_Var23 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)

		attendeesJson, _ := json.Marshal(slot.Attendees)
		var templ_7745c5c3_Var24 = []any{"w-full rounded-[8px] p-1.5 flex flex-col gap-1 text-left transition-transform active:scale-95 " + BgSurface}
		templ_7745c5c3_Err = templ.RenderCSSItems(ctx, templ_7745c5c3_Buffer, templ_7745c5c3_Var24...)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 32, "<button class=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var25 string
		templ_7745c5c3_Var25, templ_7745c5c3_Err = templ.JoinStringErrs(templ.CSSClasses(templ_7745c5c3_Var24).String())
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 1, Col: 0}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var25))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 33, "\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templ.RenderAttributes(ctx, templ_7745c5c3_Buffer, templ.Attributes{"onclick": fmt.Sprintf("openBookingPopup('%s', '%s', '%s', %s)", slot.ID, slot.TimeDisplay, slot.CourseName, string(attendeesJson))})
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 34, "><!-- Header: Time & Title --><div class=\"flex flex-col leading-tight\"><span class=\"text-[10px] text-[#8E8E93] font-mono\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var26 string
		templ_7745c5c3_Var26, templ_7745c5c3_Err = templ.JoinStringErrs(slot.TimeDisplay)
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 242, Col: 72}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var26))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 35, "</span> <span class=\"text-xs font-bold text-white truncate\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var27 string
		templ_7745c5c3_Var27, templ_7745c5c3_Err = templ.JoinStringErrs(slot.CourseName)
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 243, Col: 72}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var27))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 36, "</span></div><!-- Name Tag Stack (Only Booked/Leave) --><div class=\"flex flex-col gap-1 mt-1\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		for _, p := range slot.Attendees {
			if p.Status == "Booked" {
				var templ_7745c5c3_Var28 = []any{"text-[9px] px-1.5 py-0.5 rounded-[4px] text-white truncate " + ColorBlue}
				templ_7745c5c3_Err = templ.RenderCSSItems(ctx, templ_7745c5c3_Buffer, templ_7745c5c3_Var28...)
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 37, "<span class=\"")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var29 string
				templ_7745c5c3_Var29, templ_7745c5c3_Err = templ.JoinStringErrs(templ.CSSClasses(templ_7745c5c3_Var28).String())
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 1, Col: 0}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var29))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 38, "\">")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var30 string
				templ_7745c5c3_Var30, templ_7745c5c3_Err = templ.JoinStringErrs(p.Name)
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 251, Col: 14}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var30))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 39, "</span>")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
			} else if p.Status == "Leave" {
				var templ_7745c5c3_Var31 = []any{"text-[9px] px-1.5 py-0.5 rounded-[4px] border border-[#F87171] text-[#F87171] truncate"}
				templ_7745c5c3_Err = templ.RenderCSSItems(ctx, templ_7745c5c3_Buffer, templ_7745c5c3_Var31...)
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 40, "<span class=\"")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var32 string
				templ_7745c5c3_Var32, templ_7745c5c3_Err = templ.JoinStringErrs(templ.CSSClasses(templ_7745c5c3_Var31).String())
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 1, Col: 0}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var32))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 41, "\">")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var33 string
				templ_7745c5c3_Var33, templ_7745c5c3_Err = templ.JoinStringErrs(p.Name)
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 255, Col: 14}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var33))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 42, "</span>")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
			}
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 43, "</div></button>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// EmptyCapsule renders an empty/bookable slot placeholder.
func EmptyCapsule(slot *SlotData) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var34 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var34 == nil {
			templ_7745c5c3_Var34 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 44, "<div class=\"w-full rounded-[8px] p-2 border border-dashed border-[#3A3A3C] flex items-center justify-center text-left min-h-[40px] opacity-50 cursor-default\"><span class=\"text-[10px] text-[#8E8E93]\">[未排課]</span></div>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// FixedFABs renders the bottom floating buttons.
func FixedFABs() templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var35 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var35 == nil {
			templ_7745c5c3_Var35 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 45, "<div class=\"fixed bottom-6 left-4 right-4 flex justify-between items-end pointer-events-none z-50\"><!-- My Bookings (Left) --><button onclick=\"openMyBookings()\" class=\"pointer-events-auto bg-[#1C1C1E] text-white border border-[#3A3A3C] shadow-lg rounded-full px-5 py-3 font-semibold text-sm flex items-center gap-2 active:bg-[#2C2C2E] transition-colors\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2\"></path><circle cx=\"12\" cy=\"7\" r=\"4\"></circle></svg> 我的預約</button><!-- Share (Right) --><button onclick=\"shareBookingStatus()\" class=\"pointer-events-auto bg-[#06C755] text-white shadow-lg rounded-full px-5 py-3 font-semibold text-sm flex items-center gap-2 active:bg-[#05B04B] transition-colors\"><span>分享預約</span> <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"18\" cy=\"5\" r=\"3\"></circle><circle cx=\"6\" cy=\"12\" r=\"3\"></circle><circle cx=\"18\" cy=\"19\" r=\"3\"></circle><line x1=\"8.59\" y1=\"13.51\" x2=\"15.42\" y2=\"17.49\"></line><line x1=\"15.41\" y1=\"6.51\" x2=\"8.59\" y2=\"10.49\"></line></svg></button></div>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// BookingPopup renders the Smart Booking Input modal.
func BookingPopup(user *UserContext) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var36 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var36 == nil {
			templ_7745c5c3_Var36 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 46, "<div id=\"booking-popup\" class=\"fixed inset-0 z-[60] hidden flex items-end sm:items-center justify-center\" role=\"dialog\" aria-modal=\"true\"><!-- Backdrop --><div class=\"absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity\" onclick=\"closeBookingPopup()\"></div><!-- Modal Content --><div class=\"relative w-full max-w-md bg-[#1C1C1E] rounded-t-xl sm:rounded-xl p-5 shadow-2xl transform transition-transform overflow-hidden\"><!-- Header --><div class=\"flex justify-between items-start mb-4\"><div><h3 id=\"popup-course-title\" class=\"text-xl font-bold text-white\">Course Title</h3><p id=\"popup-time-info\" class=\"text-sm text-[#8E8E93] mt-1\">Date Time Location</p><!-- Hidden Slot ID for submission --><input type=\"hidden\" id=\"popup-slot-id\"></div><button onclick=\"closeBookingPopup()\" class=\"text-[#8E8E93] p-1\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line><line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line></svg></button></div><!-- MAIN VIEW --><div id=\"booking-main-view\"><!-- Participants List (Existing Bookings) --><div class=\"mb-4\" id=\"booked-list-wrapper\"><label class=\"block text-xs font-medium text-[#8E8E93] mb-2 uppercase\">已加入名單 (點擊可管理)</label><div id=\"booked-participants-list\" class=\"flex flex-wrap gap-2 min-h-[32px]\"><!-- Interactive Tags injected via JS --></div></div><!-- Smart Input Area (New Entries) --><div class=\"mb-4\"><label class=\"block text-xs font-medium text-[#8E8E93] mb-2 uppercase\">新增參與者 (輸入名字或從下方選擇)</label><!-- Tag Container & Input --><div class=\"flex flex-wrap gap-2 p-3 bg-[#000000] border border-[#3A3A3C] rounded-lg min-h-[50px] items-center\" id=\"smart-input-container\"><!-- Draft Tags injected here --><!-- Just Input here --><input type=\"text\" id=\"smart-input\" class=\"bg-transparent border-none outline-none text-white text-base min-w-[100px] flex-grow placeholder-[#525252]\" placeholder=\"輸入名字...\" autocomplete=\"off\"></div></div><!-- Frequent List (Quick Select) --><div class=\"mb-6\"><label class=\"block text-xs font-medium text-[#8E8E93] mb-2\">快速選擇</label><div class=\"flex flex-wrap gap-2\" id=\"frequent-names-list\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		for _, name := range user.FrequentChildren {
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 47, "<button")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templ.RenderAttributes(ctx, templ_7745c5c3_Buffer, templ.Attributes{"onclick": fmt.Sprintf("addDraftTag('%s')", name)})
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 48, " class=\"px-3 py-1.5 rounded-full bg-[#27272A] text-white text-sm border border-[#3A3A3C] hover:bg-[#3A3A3C]\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var37 string
			templ_7745c5c3_Var37, templ_7745c5c3_Err = templ.JoinStringErrs(name)
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 359, Col: 14}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var37))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 49, "</button>")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 50, "</div></div><!-- Footer --><div class=\"flex gap-3 mt-6\"><button onclick=\"submitBooking()\" class=\"w-full bg-[#FFD700] text-black font-bold py-3 rounded-lg text-base hover:bg-[#E6C200] transition-colors\">完成</button></div></div><!-- LEAVE FORM VIEW (Hidden by default) --><div id=\"booking-leave-view\" class=\"hidden\"><form id=\"leave-request-form\" onsubmit=\"submitLeaveRequest(event)\"><input type=\"hidden\" id=\"leave-booking-id\" name=\"bookingId\"><div class=\"mb-4\"><p class=\"text-white text-lg font-bold mb-1\"><span id=\"leave-student-name\" class=\"text-[#FFD700]\"></span> <span class=\"text-white\">要請假</span></p></div><div class=\"mb-4\"><label for=\"leaveReason\" class=\"block text-sm font-medium text-[#8E8E93] mb-2\">請假原因</label> <textarea id=\"leaveReason\" name=\"reason\" rows=\"4\" class=\"w-full bg-[#000000] border border-[#3A3A3C] rounded-lg p-3 text-white text-sm focus:border-[#FFD700] outline-none transition-colors resize-none\" placeholder=\"請輸入請假原因...\" required></textarea></div><div class=\"flex gap-3 pt-2\"><button type=\"button\" onclick=\"cancelLeaveRequest()\" class=\"flex-1 px-4 py-2.5 rounded-lg border border-[#3A3A3C] text-white text-sm font-medium hover:bg-[#27272A] transition-colors\">取消</button> <button type=\"submit\" class=\"flex-1 px-4 py-2.5 rounded-lg bg-[#FFD700] text-black text-sm font-bold hover:bg-[#E6C200] transition-colors\">提交申請</button></div></form></div><!-- INLINE CONFIRMATION PANEL -->")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = InlineConfirmation("booking").Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 51, "</div></div>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// InlineConfirmation renders a bottom-sheet style confirmation panel inside a modal.
func InlineConfirmation(idPrefix string) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var38 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var38 == nil {
			templ_7745c5c3_Var38 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 52, "<div id=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var39 string
		templ_7745c5c3_Var39, templ_7745c5c3_Err = templ.JoinStringErrs(idPrefix + "-confirm-panel")
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 422, Col: 34}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var39))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 53, "\" class=\"absolute bottom-0 left-0 right-0 bg-[#2C2C2E] p-5 pt-6 rounded-t-2xl sm:rounded-xl z-[70] flex flex-col gap-4 transform transition-transform duration-300 translate-y-full border-t border-[#3A3A3C] shadow-2xl\"><div class=\"text-center\"><h4 id=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var40 string
		templ_7745c5c3_Var40, templ_7745c5c3_Err = templ.JoinStringErrs(idPrefix + "-confirm-title")
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 426, Col: 39}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var40))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 54, "\" class=\"text-white font-bold text-lg mb-1\">Confirm Action</h4><p id=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var41 string
		templ_7745c5c3_Var41, templ_7745c5c3_Err = templ.JoinStringErrs(idPrefix + "-confirm-msg")
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 427, Col: 36}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var41))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 55, "\" class=\"text-[#8E8E93] text-sm\">Are you sure?</p></div><div class=\"flex gap-3\"><button id=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var42 string
		templ_7745c5c3_Var42, templ_7745c5c3_Err = templ.JoinStringErrs(idPrefix + "-confirm-cancel")
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 431, Col: 37}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var42))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 56, "\" class=\"flex-1 py-3 rounded-xl border border-[#3A3A3C] text-white font-bold text-sm hover:bg-[#3A3A3C] transition-colors\">取消</button> <button id=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var43 string
		templ_7745c5c3_Var43, templ_7745c5c3_Err = templ.JoinStringErrs(idPrefix + "-confirm-ok")
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 437, Col: 33}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var43))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 57, "\" class=\"flex-1 py-3 rounded-xl bg-[#FFD700] text-black font-bold text-sm hover:bg-[#E6C200] transition-colors\">確定</button></div></div>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// MyBookingsModal renders the list of my bookings.
func MyBookingsModal(bookings []*MyBookingItem) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var44 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var44 == nil {
			templ_7745c5c3_Var44 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 58, "<div id=\"my-bookings-modal\" class=\"fixed inset-0 z-[60] hidden flex items-end justify-center sm:items-center\" role=\"dialog\" aria-modal=\"true\"><div class=\"absolute inset-0 bg-black/80 backdrop-blur-sm\" onclick=\"closeMyBookings()\"></div><div class=\"relative w-full max-w-md h-[85vh] bg-[#1C1C1E] rounded-t-xl sm:rounded-xl shadow-2xl flex flex-col overflow-hidden\"><!-- Header --><div class=\"flex justify-between items-center p-4 border-b border-[#27272A]\"><h3 class=\"text-lg font-bold text-white\">我的預約</h3><button onclick=\"closeMyBookings()\" class=\"text-[#8E8E93] p-1\">✕</button></div><!-- Content --><div class=\"flex-grow overflow-y-auto p-4 space-y-4\"><!-- Tabs --><div class=\"flex gap-4 border-b border-[#27272A] mb-4\"><button id=\"tab-upcoming\" onclick=\"switchMyBookingsTab('upcoming')\" class=\"pb-2 text-[#FFD700] border-b-2 border-[#FFD700] font-medium transition-colors\">即將到來</button> <button id=\"tab-history\" onclick=\"switchMyBookingsTab('history')\" class=\"pb-2 text-[#8E8E93] font-medium hover:text-white transition-colors border-b-2 border-transparent\">歷史紀錄</button></div><!-- List Items --><div id=\"my-bookings-list\" class=\"space-y-3\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		for _, item := range bookings {
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 59, "<div class=\"bg-[#000000] p-3 rounded-lg border border-[#27272A]\"><div class=\"flex justify-between items-start mb-2\"><div><div class=\"text-white font-bold\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var45 string
			templ_7745c5c3_Var45, templ_7745c5c3_Err = templ.JoinStringErrs(item.DateDisplay)
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 488, Col: 61}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var45))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 60, "</div><div class=\"text-xs text-[#8E8E93]\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var46 string
			templ_7745c5c3_Var46, templ_7745c5c3_Err = templ.JoinStringErrs(item.Title)
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 489, Col: 57}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var46))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 61, "</div></div></div><!-- Name Tags --><div class=\"flex flex-wrap gap-2\">")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			for _, p := range item.Attendees {
				var templ_7745c5c3_Var47 = []any{"text-xs px-2 py-1 rounded transition-colors " +
					cond(p.Status == "Booked", "bg-[#60A5FA] text-white",
						cond(p.Status == "Leave", "border border-[#F87171] text-[#F87171]", "text-[#8E8E93]"))}
				templ_7745c5c3_Err = templ.RenderCSSItems(ctx, templ_7745c5c3_Buffer, templ_7745c5c3_Var47...)
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 62, "<button class=\"")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var48 string
				templ_7745c5c3_Var48, templ_7745c5c3_Err = templ.JoinStringErrs(templ.CSSClasses(templ_7745c5c3_Var47).String())
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 1, Col: 0}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var48))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 63, "\"")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templ.RenderAttributes(ctx, templ_7745c5c3_Buffer, templ.Attributes{"onclick": fmt.Sprintf("handleMyBookingTagClick(this, '%s', '%s', '%s', '%s')", p.Name, p.Status, p.BookingTime.Format(time.RFC3339), p.BookingID)})
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 64, ">")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var49 string
				templ_7745c5c3_Var49, templ_7745c5c3_Err = templ.JoinStringErrs(p.Name)
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 503, Col: 18}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var49))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 65, " ")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var50 string
				templ_7745c5c3_Var50, templ_7745c5c3_Err = templ.JoinStringErrs(cond(p.Status == "Leave", "(請假)", ""))
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/forms/booking_v2/booking_v2.templ`, Line: 503, Col: 64}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var50))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 66, "</button>")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 67, "</div></div>")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 68, "</div></div><!-- INLINE CONFIRMATION PANEL -->")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = InlineConfirmation("my-booking").Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 69, "</div></div>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// Script includes AlpineJS (optional but helpful) or Vanilla JS for logic.
func Script(liffId string) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var51 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var51 == nil {
			templ_7745c5c3_Var51 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 70, "<script src=\"https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js\" defer></script><script>\n\t\t// --- API Helper ---\n\t\tasync function fetchApi(url, options = {}) {\n\t\t\tconst headers = { 'Content-Type': 'application/json', ...options.headers };\n\t\t\tconst response = await fetch(url, { ...options, headers });\n\t\t\tconst data = await response.json();\n\t\t\tif (!response.ok) {\n\t\t\t\tthrow new Error(data.message || 'API request failed');\n\t\t\t}\n\t\t\treturn data;\n\t\t}\n\n\t\tlet currentYear = null;\n\t\tlet currentMonth = null;\n\n\t\tfunction updateHeaderTitle() {\n\t\t\tconst container = document.getElementById('calendar-container');\n\t\t\tconst titleEl = document.getElementById('current-month-title');\n\t\t\tif (!container || !titleEl) return;\n\n\t\t\tconst weeks = container.querySelectorAll('[data-week-id]');\n\t\t\tconst containerRect = container.getBoundingClientRect();\n\t\t\t\n\t\t\tfor (let week of weeks) {\n\t\t\t\tconst rect = week.getBoundingClientRect();\n\t\t\t\tif (rect.bottom > containerRect.top + 100) {\n\t\t\t\t\tconst firstDay = week.querySelector('[data-date]');\n\t\t\t\t\tif (firstDay) {\n\t\t\t\t\t\tconst parts = firstDay.dataset.date.split('-');\n\t\t\t\t\t\tconst year = parts[0];\n\t\t\t\t\t\tconst month = parseInt(parts[1], 10);\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (year !== currentYear || month !== currentMonth) {\n\t\t\t\t\t\t\tcurrentYear = year;\n\t\t\t\t\t\t\tcurrentMonth = month;\n\t\t\t\t\t\t\ttitleEl.innerText = `${year}年${month}月`;\n\t\t\t\t\t\t\tfetchMonthlyStats(year, month);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tasync function fetchMonthlyStats(year, month) {\n\t\t\tconst statsLabel = document.getElementById('stats-label');\n\t\t\tif (statsLabel) statsLabel.innerText = `${year}年${month}月統計:`;\n\t\t\t\n\t\t\ttry {\n\t\t\t\tconst stats = await fetchApi(`/api/v2/calendar/stats?year=${year}&month=${month}`);\n\t\t\t\trenderStats(stats);\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"Failed to fetch stats:\", err);\n\t\t\t}\n\t\t}\n\n\t\tfunction renderStats(stats) {\n\t\t\tconst totalSessionsEl = document.getElementById('total-sessions');\n\t\t\tconst totalLeaveEl = document.getElementById('total-leave');\n\t\t\tconst childrenBody = document.getElementById('stats-children-body');\n\n\t\t\tif (totalSessionsEl) totalSessionsEl.innerText = `${stats.total_sessions} 堂`;\n\t\t\tif (totalLeaveEl) totalLeaveEl.innerText = stats.total_leave;\n\n\t\t\tif (childrenBody && stats.children) {\n\t\t\t\tchildrenBody.innerHTML = stats.children.map(child => {\n\t\t\t\t\tconst absentClass = child.absent > 0 ? 'text-[#F87171]' : 'text-[#8E8E93]';\n\t\t\t\t\treturn `\n\t\t\t\t\t\t<tr class=\"border-b border-[#27272A]/50 last:border-0\">\n\t\t\t\t\t\t\t<td class=\"py-2 text-left\">${child.name}</td>\n\t\t\t\t\t\t\t<td class=\"py-2 text-[#34D399]\">${child.completed}</td>\n\t\t\t\t\t\t\t<td class=\"py-2 text-[#8E8E93]\">${child.leave}</td>\n\t\t\t\t\t\t\t<td class=\"py-2 ${absentClass}\">${child.absent}</td>\n\t\t\t\t\t\t\t<td class=\"py-2 text-[#8E8E93]\">${child.avg_week.toFixed(1)}</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t`;\n\t\t\t\t}).join('');\n\t\t\t}\n\t\t}\n\n\t\t// --- Custom Inline Async Confirm ---\n\t\tfunction showInlineConfirm(idPrefix, title, message) {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tconst panel = document.getElementById(idPrefix + '-confirm-panel');\n\t\t\t\tconst titleEl = document.getElementById(idPrefix + '-confirm-title');\n\t\t\t\tconst msgEl = document.getElementById(idPrefix + '-confirm-msg');\n\t\t\t\tconst btnCancel = document.getElementById(idPrefix + '-confirm-cancel');\n\t\t\t\tconst btnOk = document.getElementById(idPrefix + '-confirm-ok');\n\n\t\t\t\ttitleEl.innerText = title;\n\t\t\t\tmsgEl.innerText = message;\n\t\t\t\t\n\t\t\t\tpanel.classList.remove('hidden');\n\t\t\t\trequestAnimationFrame(() => panel.classList.remove('translate-y-full'));\n\n\t\t\t\tconst cleanup = (result) => {\n\t\t\t\t\tpanel.classList.add('translate-y-full');\n\t\t\t\t\tsetTimeout(() => panel.classList.add('hidden'), 300);\n\t\t\t\t\tbtnCancel.onclick = null;\n\t\t\t\t\tbtnOk.onclick = null;\n\t\t\t\t\tresolve(result);\n\t\t\t\t};\n\n\t\t\t\tbtnCancel.onclick = () => cleanup(false);\n\t\t\t\tbtnOk.onclick = () => cleanup(true);\n\t\t\t});\n\t\t}\n\n\t\t// --- Calendar Infinite Scroll Logic ---\n\t\tlet firstLoadedDate = null;\n\t\tlet lastLoadedDate = null;\n\t\tlet isLoading = false;\n\t\tlet isEndTop = false;\n\t\tlet isEndBottom = false;\n\t\tlet autoLoadCount = 0;\n\t\tconst MAX_AUTO_LOADS = 3;\n\t\tlet observer;\n\n\t\tdocument.addEventListener('DOMContentLoaded', () => {\n\t\t\tconst days = document.querySelectorAll('[data-date]');\n\t\t\tif (days.length > 0) {\n\t\t\t\tfirstLoadedDate = days[0].dataset.date;\n\t\t\t\tlastLoadedDate = days[days.length - 1].dataset.date;\n\t\t\t\tconsole.log(\"Init dates:\", firstLoadedDate, \"to\", lastLoadedDate);\n\t\t\t}\n\n\t\t\tconst container = document.getElementById('calendar-container');\n\t\t\t// Find the \"today\" circle indicator (bg-white text-black)\n\t\t\tconst todayIndicator = container.querySelector('.bg-white.text-black');\n\t\t\t\n\t\t\tif (todayIndicator) {\n\t\t\t\tconsole.log(\"Found today indicator, scrolling to center.\");\n\t\t\t\t// Scroll the day column (parent) into view, centered\n\t\t\t\ttodayIndicator.parentElement.scrollIntoView({ block: 'center' });\n\t\t\t} else {\n\t\t\t\tconsole.log(\"Today indicator not found, scrolling to offset 20.\");\n\t\t\t\t// Fallback: scroll down slightly to hide top sentinel\n\t\t\t\tif (container.scrollHeight > container.clientHeight) {\n\t\t\t\t\tcontainer.scrollTop = 20; \n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add scroll listener for robust boundary detection\n\t\t\tcontainer.addEventListener('scroll', () => {\n\t\t\t\t// Reset auto-load count on manual interaction, allowing recursion to resume if needed\n\t\t\t\tautoLoadCount = 0;\n\t\t\t\tupdateHeaderTitle();\n\n\t\t\t\tif (isLoading) return;\n\n\t\t\t\tconst { scrollTop, scrollHeight, clientHeight } = container;\n\t\t\t\tconst threshold = 100; // px\n\n\t\t\t\tif (scrollTop < threshold && !isEndTop) {\n\t\t\t\t\tconsole.log(\"Scroll top trigger\");\n\t\t\t\t\tloadWeeks('prev');\n\t\t\t\t} else if (scrollHeight - scrollTop - clientHeight < threshold && !isEndBottom) {\n\t\t\t\t\tconsole.log(\"Scroll bottom trigger\");\n\t\t\t\t\tloadWeeks('next');\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Delay observer setup to avoid triggering on initial layout/scroll\n\t\t\tsetTimeout(setupInfiniteScroll, 500); \n\t\t\tupdateHeaderTitle();\n\t\t});\n\n\t\tfunction setupInfiniteScroll() {\n\t\t\tconsole.log(\"Setting up infinite scroll observer...\");\n\t\t\tconst options = {\n\t\t\t\troot: document.getElementById('calendar-container'),\n\t\t\t\trootMargin: '50px 0px', // Increased margin to trigger earlier\n\t\t\t\tthreshold: 0\n\t\t\t};\n\n\t\t\tobserver = new IntersectionObserver((entries) => {\n\t\t\t\tentries.forEach(entry => {\n\t\t\t\t\tconsole.log(\"Observer event:\", entry.target.id, \"Intersecting:\", entry.isIntersecting, \"isLoading:\", isLoading);\n\t\t\t\t\tif (entry.isIntersecting) {\n\t\t\t\t\t\t// Reset auto-load counter when user manually scrolls to a sentinel\n\t\t\t\t\t\tautoLoadCount = 0;\n\t\t\t\t\t\tif (!isLoading) {\n\t\t\t\t\t\t\tif (entry.target.id === 'sentinel-top' && !isEndTop) {\n\t\t\t\t\t\t\t\tloadWeeks('prev');\n\t\t\t\t\t\t\t} else if (entry.target.id === 'sentinel-bottom' && !isEndBottom) {\n\t\t\t\t\t\t\t\tloadWeeks('next');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}, options);\n\n\t\t\tconst topSentinel = document.getElementById('sentinel-top');\n\t\t\tconst bottomSentinel = document.getElementById('sentinel-bottom');\n\t\t\t\n\t\t\tif (topSentinel) observer.observe(topSentinel);\n\t\t\tif (bottomSentinel) observer.observe(bottomSentinel);\n\t\t}\n\n\t\tasync function loadWeeks(direction) {\n\t\t\tif (isLoading) return;\n\t\t\t// Double check flags to prevent manual calls bypassing logic\n\t\t\tif (direction === 'prev' && isEndTop) return;\n\t\t\tif (direction === 'next' && isEndBottom) return;\n\t\t\t\n\t\t\tconst container = document.getElementById('calendar-container');\n\t\t\tconst referenceDate = (direction === 'next') ? lastLoadedDate : firstLoadedDate;\n\t\t\t\n\t\t\tconsole.log(\"Loading weeks:\", direction, \"Ref Date:\", referenceDate);\n\n\t\t\tif (!referenceDate) {\n\t\t\t\tconsole.error(\"No reference date found!\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tisLoading = true;\n\t\t\t\n\t\t\ttry {\n\t\t\t\tconst data = await fetchApi(`/api/v2/calendar/weeks?start_date=${referenceDate}&direction=${direction}`);\n\t\t\t\t\n\t\t\t\tif (data.weeks && data.weeks.length > 0) {\n\t\t\t\t\t// Capture height before prepending\n\t\t\t\t\tconst prevScrollHeight = container.scrollHeight;\n\t\t\t\t\tconst prevScrollTop = container.scrollTop;\n\n\t\t\t\t\tconst newWeeksHtml = data.weeks.map(week => renderWeekRow(week)).join('');\n\t\t\t\t\tconst tempDiv = document.createElement('div');\n\t\t\t\t\ttempDiv.innerHTML = newWeeksHtml;\n\t\t\t\t\tconst newElements = Array.from(tempDiv.children);\n\n\t\t\t\t\tconst topSentinel = document.getElementById('sentinel-top');\n\t\t\t\t\tconst bottomSentinel = document.getElementById('sentinel-bottom');\n\n\t\t\t\t\tif (direction === 'next') {\n\t\t\t\t\t\tnewElements.forEach(el => container.insertBefore(el, bottomSentinel));\n\t\t\t\t\t\t// Update lastLoadedDate\n\t\t\t\t\t\tconst lastWeek = data.weeks[data.weeks.length - 1];\n\t\t\t\t\t\tconst lastDay = lastWeek.days[lastWeek.days.length - 1];\n\t\t\t\t\t\tlastLoadedDate = lastDay.full_date;\n\t\t\t\t\t\tconsole.log(\"New lastLoadedDate:\", lastLoadedDate);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Prepend after topSentinel\n\t\t\t\t\t\tnewElements.reverse().forEach(el => {\n\t\t\t\t\t\t\tif (topSentinel.nextSibling) {\n\t\t\t\t\t\t\t\tcontainer.insertBefore(el, topSentinel.nextSibling);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tcontainer.appendChild(el);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t\t// Maintain scroll position\n\t\t\t\t\t\tconst newScrollHeight = container.scrollHeight;\n\t\t\t\t\t\tcontainer.scrollTop = newScrollHeight - prevScrollHeight + prevScrollTop;\n\n\t\t\t\t\t\t// Update firstLoadedDate\n\t\t\t\t\t\tconst firstWeek = data.weeks[0];\n\t\t\t\t\t\tconst firstDay = firstWeek.days[0];\n\t\t\t\t\t\tfirstLoadedDate = firstDay.full_date;\n\t\t\t\t\t\tconsole.log(\"New firstLoadedDate:\", firstLoadedDate);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (direction === 'next') {\n\t\t\t\t\t\tisEndBottom = true;\n\t\t\t\t\t\talert(\"沒有更晚的課程了\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\tisEndTop = true;\n\t\t\t\t\t\talert(\"沒有更早的課程了\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"Failed to load weeks:\", err);\n\t\t\t} finally {\n\t\t\t\tconsole.log(\"Finished loading, resetting isLoading\");\n\t\t\t\tupdateHeaderTitle();\n\t\t\t\t// Small delay before allowing next fetch to prevent double-triggering while layout settles\n\t\t\t\tsetTimeout(() => { \n\t\t\t\t\tisLoading = false; \n\t\t\t\t\tcheckVisibleSentinels();\n\t\t\t\t}, 500);\n\t\t\t}\n\t\t}\n\n\t\tfunction checkVisibleSentinels() {\n\t\t\tif (autoLoadCount >= MAX_AUTO_LOADS) {\n\t\t\t\tconsole.log(\"Max auto loads reached, stopping recursion.\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst container = document.getElementById('calendar-container');\n\t\t\tconst topSentinel = document.getElementById('sentinel-top');\n\t\t\tconst bottomSentinel = document.getElementById('sentinel-bottom');\n\n\t\t\tif (!container || !topSentinel || !bottomSentinel) return;\n\n\t\t\tconst cRect = container.getBoundingClientRect();\n\n\t\t\t// Helper to check if element is within the container's viewport\n\t\t\tconst isVisible = (el) => {\n\t\t\t\tconst rect = el.getBoundingClientRect();\n\t\t\t\t// Allow a small buffer (e.g., 10px) to ensure we catch edge cases\n\t\t\t\treturn (rect.bottom >= cRect.top - 10 && rect.top <= cRect.bottom + 10);\n\t\t\t};\n\n\t\t\tif (!isLoading) {\n\t\t\t\tif (!isEndBottom && isVisible(bottomSentinel)) {\n\t\t\t\t\tconsole.log(\"Bottom sentinel still visible, triggering next load...\");\n\t\t\t\t\tautoLoadCount++;\n\t\t\t\t\tloadWeeks('next');\n\t\t\t\t} else if (!isEndTop && isVisible(topSentinel)) {\n\t\t\t\t\tconsole.log(\"Top sentinel still visible, triggering prev load...\");\n\t\t\t\t\tautoLoadCount++;\n\t\t\t\t\tloadWeeks('prev');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfunction renderWeekRow(week) {\n\t\t\tlet daysHtml = '';\n\t\t\tweek.days.forEach(day => {\n\t\t\t\tlet slotsHtml = '';\n\t\t\t\tday.slots.forEach(slot => {\n\t\t\t\t\tif (slot.is_empty) {\n\t\t\t\t\t\tslotsHtml += `<div class=\"w-full rounded-[8px] p-2 border border-dashed border-[#3A3A3C] flex items-center justify-center text-left min-h-[40px] opacity-50 cursor-default\"><span class=\"text-[10px] text-[#8E8E93]\">[未排課]</span></div>`;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst attendeesJson = JSON.stringify(slot.attendees || []);\n\t\t\t\t\t\tlet nameTagsHtml = '';\n\t\t\t\t\t\t(slot.attendees || []).forEach(p => {\n\t\t\t\t\t\t\tif (p.status === 'Booked') {\n\t\t\t\t\t\t\t\tnameTagsHtml += `<span class=\"text-[9px] px-1.5 py-0.5 rounded-[4px] text-white truncate bg-[#60A5FA]\">${p.name}</span>`;\n\t\t\t\t\t\t\t} else if (p.status === 'Leave') {\n\t\t\t\t\t\t\t\tnameTagsHtml += `<span class=\"text-[9px] px-1.5 py-0.5 rounded-[4px] border border-[#F87171] text-[#F87171] truncate\">${p.name}</span>`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tslotsHtml += `\n\t\t\t\t\t\t\t<button class=\"w-full rounded-[8px] p-1.5 flex flex-col gap-1 text-left transition-transform active:scale-95 bg-[#1C1C1E]\" \n\t\t\t\t\t\t\t\tonclick=\"openBookingPopup('${slot.id}', '${slot.time_display}', '${slot.course_name}', ${attendeesJson.replace(/\"/g, '&quot;')})\">\n\t\t\t\t\t\t\t\t<div class=\"flex flex-col leading-tight\">\n\t\t\t\t\t\t\t\t\t<span class=\"text-[10px] text-[#8E8E93] font-mono\">${slot.time_display}</span>\n\t\t\t\t\t\t\t\t\t<span class=\"text-xs font-bold text-white truncate\">${slot.course_name}</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class=\"flex flex-col gap-1 mt-1\">${nameTagsHtml}</div>\n\t\t\t\t\t\t\t</button>`;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tconst todayClass = day.is_today ? \"bg-white text-black\" : \"text-[#8E8E93]\";\n\t\t\t\tdaysHtml += `\n\t\t\t\t\t<div class=\"flex flex-col items-center gap-2 min-h-[120px]\" data-date=\"${day.full_date}\">\n\t\t\t\t\t\t<div class=\"flex flex-col items-center justify-center w-10 h-10 rounded-full text-sm font-medium ${todayClass}\">\n\t\t\t\t\t\t\t<span class=\"text-[10px] uppercase leading-none\">${day.day_of_week}</span>\n\t\t\t\t\t\t\t<span class=\"text-lg leading-none font-bold\">${day.date_display}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"w-full flex flex-col gap-2 px-0.5\">${slotsHtml}</div>\n\t\t\t\t\t</div>`;\n\t\t\t});\n\n\t\t\treturn `<div class=\"snap-start pt-4 pb-2 border-b border-[#27272A] min-h-[50vh]\" data-week-id=\"${week.id}\"><div class=\"grid grid-cols-7 gap-1 px-1\">${daysHtml}</div></div>`;\n\t\t}\n\n\t\t// --- Popup Logic ---\n\t\tfunction openBookingPopup(slotId, time, title, attendees) {\n\t\t\tdocument.getElementById('popup-course-title').innerText = title;\n\t\t\tdocument.getElementById('popup-time-info').innerText = time;\n\t\t\tdocument.getElementById('popup-slot-id').value = slotId;\n\t\t\t\n\t\t\tconst bookedContainer = document.getElementById('booked-participants-list');\n\t\t\tconst draftContainer = document.getElementById('smart-input-container');\n\t\t\tbookedContainer.innerHTML = '';\n\t\t\t\n\t\t\tconst input = document.getElementById('smart-input');\n\t\t\tArray.from(draftContainer.children).forEach(child => { if (child !== input) child.remove(); });\n\t\t\tinput.value = '';\n\n\t\t\tif (attendees && attendees.length > 0) {\n\t\t\t\tdocument.getElementById('booked-list-wrapper').classList.remove('hidden');\n\t\t\t\tattendees.forEach(p => addBookedTag(p.Name || p.name, p.Status || p.status, p.BookingTime || p.booking_time, p.BookingID || p.booking_id));\n\t\t\t} else {\n\t\t\t\tdocument.getElementById('booked-list-wrapper').classList.add('hidden');\n\t\t\t}\n\n\t\t\tdocument.getElementById('booking-popup').classList.remove('hidden');\n\t\t}\n\n\t\tfunction closeBookingPopup() {\n\t\t\tdocument.getElementById('booking-popup').classList.add('hidden');\n\t\t\tdocument.getElementById('booking-leave-view').classList.add('hidden');\n\t\t\tdocument.getElementById('booking-main-view').classList.remove('hidden');\n\t\t}\n\n\t\tfunction openMyBookings() {\n\t\t\tdocument.getElementById('my-bookings-modal').classList.remove('hidden');\n\t\t\tswitchMyBookingsTab('upcoming');\n\t\t}\n\n\t\tfunction closeMyBookings() {\n\t\t\tdocument.getElementById('my-bookings-modal').classList.add('hidden');\n\t\t}\n\n\t\t// --- Create Booking Logic ---\n\t\tasync function submitBooking() {\n\t\t\tconst slotId = document.getElementById('popup-slot-id').value;\n\t\t\tconst draftTags = document.querySelectorAll('[data-draft=\"true\"]');\n\t\t\tconst names = Array.from(draftTags).map(t => t.dataset.name);\n\n\t\t\tif (names.length === 0) {\n\t\t\t\tcloseBookingPopup();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst result = await fetchApi('/api/v2/bookings', {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\tbody: JSON.stringify({ slot_id: slotId, student_names: names })\n\t\t\t\t});\n\n\t\t\t\tresult.new_bookings.forEach(b => {\n\t\t\t\t\taddBookedTag(b.name, b.status, b.booking_time, b.booking_id);\n\t\t\t\t});\n\n\t\t\t\tdraftTags.forEach(t => t.remove());\n\t\t\t\talert(\"預約成功！\"); \n\t\t\t\tcloseBookingPopup();\n\t\t\t} catch (err) {\n\t\t\t\talert(\"預約失敗: \" + err.message);\n\t\t\t}\n\t\t}\n\n\t\t// --- Leave Request Logic ---\n\t\tfunction openLeaveRequest(bookingID, name) {\n\t\t\tdocument.getElementById('leave-booking-id').value = bookingID;\n\t\t\tdocument.getElementById('leave-student-name').innerText = name;\n\t\t\tdocument.getElementById('leaveReason').value = '';\n\t\t\t\n\t\t\tdocument.getElementById('booking-main-view').classList.add('hidden');\n\t\t\tdocument.getElementById('booking-leave-view').classList.remove('hidden');\n\t\t}\n\n\t\tfunction cancelLeaveRequest() {\n\t\t\tdocument.getElementById('booking-leave-view').classList.add('hidden');\n\t\t\tdocument.getElementById('booking-main-view').classList.remove('hidden');\n\t\t}\n\n\t\tasync function submitLeaveRequest(event) {\n\t\t\tevent.preventDefault();\n\t\t\tconst bookingId = document.getElementById('leave-booking-id').value;\n\t\t\tconst reason = document.getElementById('leaveReason').value;\n\t\t\t\n\t\t\ttry {\n\t\t\t\tawait fetchApi(`/api/v2/bookings/${bookingId}/leave`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\tbody: JSON.stringify({ reason })\n\t\t\t\t});\n\t\t\t\talert(\"請假申請已送出\");\n\t\t\t\tcancelLeaveRequest();\n\t\t\t\tcloseBookingPopup();\n\t\t\t} catch (err) {\n\t\t\t\talert(\"提交失敗: \" + err.message);\n\t\t\t}\n\t\t}\n\n\t\t// --- Smart Input / Tag Logic ---\n\t\tconst inputField = document.getElementById('smart-input');\n\t\tconst bookedContainer = document.getElementById('booked-participants-list');\n\t\tconst draftContainer = document.getElementById('smart-input-container');\n\t\t\n\t\tinputField.addEventListener('keydown', (e) => {\n\t\t\tif (e.key === 'Enter' || e.key === ',') {\n\t\t\t\te.preventDefault();\n\t\t\t\tconst val = inputField.value.trim().replace(',', '');\n\t\t\t\tif (val) {\n\t\t\t\t\taddDraftTag(val);\n\t\t\t\t\tinputField.value = '';\n\t\t\t\t}\n\t\t\t} else if (e.key === 'Backspace' && inputField.value === '') {\n\t\t\t\tconst tags = draftContainer.querySelectorAll('[data-draft]');\n\t\t\t\tif (tags.length > 0) {\n\t\t\t\t\ttags[tags.length - 1].remove();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tfunction addDraftTag(name) {\n\t\t\tconst trimmedName = name.trim();\n\t\t\tif (!trimmedName) return;\n\n\t\t\tconst allTags = [\n\t\t\t\t...Array.from(bookedContainer.querySelectorAll('[data-name]')),\n\t\t\t\t...Array.from(draftContainer.querySelectorAll('[data-name]'))\n\t\t\t];\n\t\t\tif (allTags.some(t => t.dataset.name.toLowerCase() === trimmedName.toLowerCase())) return;\n\n\t\t\tconst tag = document.createElement('div');\n\t\t\ttag.className = \"flex items-center gap-1 px-3 py-1 rounded-full bg-[#27272A] text-white text-sm cursor-pointer select-none transition-all border border-[#3A3A3C]\";\n\t\t\ttag.innerHTML = `<span>${trimmedName}</span><span class=\"text-[#8E8E93] text-xs ml-1\">×</span>`;\n\t\t\ttag.dataset.name = trimmedName;\n\t\t\ttag.dataset.draft = \"true\";\n\t\t\ttag.addEventListener('click', () => tag.remove());\n\t\t\tdraftContainer.insertBefore(tag, inputField);\n\t\t}\n\n\t\tfunction addBookedTag(name, status, bookingTimeStr, bookingID) {\n\t\t\tconst tag = document.createElement('div');\n\t\t\ttag.dataset.name = name;\n\t\t\ttag.dataset.status = status;\n\t\t\ttag.dataset.bookingId = bookingID;\n\t\t\tupdateBookedTagStyle(tag, name, status);\n\t\t\t\n\t\t\ttag.addEventListener('click', () => {\n\t\t\t\thandleTagAction(\"booking\", name, tag.dataset.status, bookingTimeStr, bookingID, (newStatus) => {\n\t\t\t\t\tif (newStatus === \"Remove\") {\n\t\t\t\t\t\ttag.remove();\n\t\t\t\t\t\tif (bookedContainer.children.length === 0) {\n\t\t\t\t\t\t\tdocument.getElementById('booked-list-wrapper').classList.add('hidden');\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttag.dataset.status = newStatus;\n\t\t\t\t\t\tupdateBookedTagStyle(tag, name, newStatus);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t\tbookedContainer.appendChild(tag);\n\t\t\tdocument.getElementById('booked-list-wrapper').classList.remove('hidden');\n\t\t}\n\n\t\tfunction updateBookedTagStyle(tag, name, status) {\n\t\t\ttag.innerHTML = `<span>${name}</span>`;\n\t\t\tif (status === \"Booked\") {\n\t\t\t\ttag.className = \"flex items-center gap-1 px-3 py-1 rounded-full bg-[#60A5FA] text-white text-sm cursor-pointer select-none transition-all\";\n\t\t\t} else if (status === \"Leave\") {\n\t\t\t\ttag.className = \"flex items-center gap-1 px-3 py-1 rounded-full border border-[#F87171] text-[#F87171] text-sm cursor-pointer select-none transition-all\";\n\t\t\t}\n\t\t}\n\n\t\t// --- My Bookings Logic ---\n\t\tlet currentTab = 'upcoming';\n\n\t\tfunction switchMyBookingsTab(type) {\n\t\t\tcurrentTab = type;\n\t\t\tconst tabUpcoming = document.getElementById('tab-upcoming');\n\t\t\tconst tabHistory = document.getElementById('tab-history');\n\t\t\tconst listContainer = document.getElementById('my-bookings-list');\n\n\t\t\tif (type === 'upcoming') {\n\t\t\t\ttabUpcoming.className = \"pb-2 text-[#FFD700] border-b-2 border-[#FFD700] font-medium transition-colors\";\n\t\t\t\ttabHistory.className = \"pb-2 text-[#8E8E93] font-medium hover:text-white transition-colors border-b-2 border-transparent\";\n\t\t\t} else {\n\t\t\t\ttabHistory.className = \"pb-2 text-[#FFD700] border-b-2 border-[#FFD700] font-medium transition-colors\";\n\t\t\t\ttabUpcoming.className = \"pb-2 text-[#8E8E93] font-medium hover:text-white transition-colors border-b-2 border-transparent\";\n\t\t\t}\n\n\t\t\tlistContainer.innerHTML = '<div class=\"text-center text-[#8E8E93] py-8\">載入中...</div>';\n\n\t\t\tfetchApi(`/api/v2/my-bookings?type=${type}`)\n\t\t\t\t.then(data => renderMyBookingsList(data.items))\n\t\t\t\t.catch(err => {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tlistContainer.innerHTML = '<div class=\"text-center text-[#F87171] py-8\">載入失敗，請稍後再試</div>';\n\t\t\t\t});\n\t\t}\n\n\t\tfunction renderMyBookingsList(items) {\n\t\t\tconst container = document.getElementById('my-bookings-list');\n\t\t\tcontainer.innerHTML = '';\n\n\t\t\tif (!items || items.length === 0) {\n\t\t\t\tcontainer.innerHTML = '<div class=\"text-center text-[#8E8E93] py-8\">無預約紀錄</div>';\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\titems.forEach(item => {\n\t\t\t\tconst itemDiv = document.createElement('div');\n\t\t\t\titemDiv.className = \"bg-[#000000] p-3 rounded-lg border border-[#27272A]\";\n\t\t\t\t\n\t\t\t\tlet tagsHtml = '';\n\t\t\t\titem.attendees.forEach(p => {\n\t\t\t\t\tlet btnClass = \"text-xs px-2 py-1 rounded transition-colors \";\n\t\t\t\t\tlet displayText = p.name;\n\t\t\t\t\tlet onclickAttr = \"\";\n\n\t\t\t\t\tif (p.status === 'Booked') {\n\t\t\t\t\t\tbtnClass += \"bg-[#60A5FA] text-white\";\n\t\t\t\t\t\tif (currentTab === 'upcoming') onclickAttr = `onclick=\"handleMyBookingTagClick(this, '${p.name}', '${p.status}', '${p.booking_time}', '${p.booking_id}')\"`;\n\t\t\t\t\t} else if (p.status === 'Leave') {\n\t\t\t\t\t\tbtnClass += \"border border-[#F87171] text-[#F87171]\";\n\t\t\t\t\t\tdisplayText += \" (請假)\";\n\t\t\t\t\t\tif (currentTab === 'upcoming') onclickAttr = `onclick=\"handleMyBookingTagClick(this, '${p.name}', '${p.status}', '${p.booking_time}', '${p.booking_id}')\"`;\n\t\t\t\t\t} else if (p.status === 'CheckedIn') {\n\t\t\t\t\t\tbtnClass += \"text-[#34D399]\";\n\t\t\t\t\t\tdisplayText += \" (已簽到)\";\n\t\t\t\t\t} else {\n\t\t\t\t\t\tbtnClass += \"text-[#8E8E93]\";\n\t\t\t\t\t\tif(p.status === 'Absent') displayText += \" (缺席)\";\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\ttagsHtml += `<button class=\"${btnClass}\" ${onclickAttr}>${displayText}</button>`;\n\t\t\t\t});\n\n\t\t\t\titemDiv.innerHTML = `\n\t\t\t\t\t<div class=\"flex justify-between items-start mb-2\">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<div class=\"text-white font-bold\">${item.date_display}</div>\n\t\t\t\t\t\t\t<div class=\"text-xs text-[#8E8E93]\">${item.title}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"flex flex-wrap gap-2\">${tagsHtml}</div>\n\t\t\t\t`;\n\t\t\t\tcontainer.appendChild(itemDiv);\n\t\t\t});\n\t\t}\n\n\t\tfunction handleMyBookingTagClick(btn, name, status, bookingTimeStr, bookingID) {\n\t\t\thandleTagAction(\"my-booking\", name, status, bookingTimeStr, bookingID, (newStatus) => {\n\t\t\t\tif (newStatus === \"Remove\") {\n\t\t\t\t\tbtn.remove();\n\t\t\t\t} else {\n\t\t\t\t\tif (newStatus === \"Booked\") {\n\t\t\t\t\t\tbtn.className = \"text-xs px-2 py-1 rounded transition-colors bg-[#60A5FA] text-white\";\n\t\t\t\t\t\tbtn.innerText = name;\n\t\t\t\t\t} else if (newStatus === \"Leave\") {\n\t\t\t\t\t\tbtn.className = \"text-xs px-2 py-1 rounded transition-colors border border-[#F87171] text-[#F87171]\";\n\t\t\t\t\t\tbtn.innerText = name + \" (請假)\";\n\t\t\t\t\t}\n\t\t\t\t\tbtn.setAttribute('onclick', `handleMyBookingTagClick(this, '${name}', '${newStatus}', '${bookingTimeStr}', '${bookingID}')`);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tasync function handleTagAction(idPrefix, name, currentStatus, bookingTimeStr, bookingID, callback) {\n\t\t\tif (currentStatus === \"Booked\") {\n\t\t\t\tconst bookingTime = new Date(bookingTimeStr);\n\t\t\t\tconst now = new Date();\n\t\t\t\tconst diffHours = (now - bookingTime) / (1000 * 60 * 60);\n\n\t\t\t\tif (diffHours < 24) {\n\t\t\t\t\tif (await showInlineConfirm(idPrefix, \"取消預約\", `預約建立於 ${diffHours.toFixed(1)}h ago. Cancel directly?`)) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait fetchApi(`/api/v2/bookings/${bookingID}`, { method: 'DELETE' });\n\t\t\t\t\t\t\tcallback(\"Remove\");\n\t\t\t\t\t\t} catch (err) { alert(err.message); }\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (idPrefix === 'my-booking') {\n\t\t\t\t\t\tcloseMyBookings();\n\t\t\t\t\t\tdocument.getElementById('booking-popup').classList.remove('hidden');\n\t\t\t\t\t}\n\t\t\t\t\topenLeaveRequest(bookingID, name);\n\t\t\t\t}\n\t\t\t} else if (currentStatus === \"Leave\") {\n\t\t\t\tif (await showInlineConfirm(idPrefix, \"恢復預約\", `取消 ${name} 的請假並恢復預約？`)) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait fetchApi(`/api/v2/bookings/${bookingID}/leave`, { method: 'DELETE' });\n\t\t\t\t\t\tcallback(\"Booked\");\n\t\t\t\t\t} catch (err) { alert(err.message); }\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfunction shareBookingStatus() {\n\t\t\tif (liff.isInClient()) {\n\t\t\t\tliff.sendMessages([{ type: 'text', text: \"Booking Summary...\" }]).then(() => liff.closeWindow()).catch(console.error);\n\t\t\t} else {\n\t\t\t\talert(\"Share function requires LINE App.\");\n\t\t\t}\n\t\t}\n\n\t\tfunction cond(condition, trueVal, falseVal) {\n\t\t\treturn condition ? trueVal : falseVal;\n\t\t}\n\t</script>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// Helper for conditional strings in templ
func cond(condition bool, trueVal, falseVal string) string {
	if condition {
		return trueVal
	}
	return falseVal
}

var _ = templruntime.GeneratedTemplate
