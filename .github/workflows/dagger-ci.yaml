name: Dagger CI             # 第一行必須是 Key，不能是 "-" 開頭的清單

permissions:
  contents: read
  packages: write

on:
  push:
    branches: [ main ]      # 或是你的主分支名稱
    paths-ignore:
      - 'deploy/**'  # 如果變動只發生在 deploy 資料夾，就不觸發此 Workflow
      - 'README.md'  # 建議順便忽略文件變動
      - '.gitignore'

jobs:
  dagger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Run Dagger Call
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: call
          # 修改 args：將參數對接到 GHCR 的邏輯
          # 1. username 改用 github.repository_owner (會自動轉小寫處理建議在 Dagger 內做)
          # 2. 這裡假設你的 Dagger 函數名還是 build-with-dockerfile
          args: "build-with-go-sdk --src=. --username=${{ github.repository_owner }} --repo-name=seanaigent --tag=${{ github.sha }} --docker-hub-token=env:GH_TOKEN"
        env:
          # 使用內建的 GITHUB_TOKEN，不需要另外去 Settings 設 Secret
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}